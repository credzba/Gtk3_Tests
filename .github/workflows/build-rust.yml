name: Build Rust Projects

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'rust/**'
      - '.github/workflows/build-rust.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'rust/**'
      - '.github/workflows/build-rust.yml'
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install GTK3 dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libgtk-3-dev
    
    - name: Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        profile: minimal
        override: true
    
    - name: Cache cargo registry
      uses: actions/cache@v3
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Cache cargo index
      uses: actions/cache@v3
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Cache cargo build
      uses: actions/cache@v3
      with:
        path: target
        key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Build
      working-directory: rust/hello_world
      run: make release
    
    - name: Run tests
      working-directory: rust/hello_world
      run: make test
    
    - name: Package
      working-directory: rust/hello_world
      run: make package
    
    - name: Upload Linux artifact
      uses: actions/upload-artifact@v3
      with:
        name: hello-world-linux-x86_64
        path: rust/hello_world/*.tar.gz
        if-no-files-found: error

  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup GTK3 for Windows
      run: |
        choco install msys2 -y
        C:\tools\msys64\usr\bin\bash -lc "pacman -S --noconfirm mingw-w64-x86_64-gtk3"
        echo "C:\tools\msys64\mingw64\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
    
    - name: Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable-x86_64-pc-windows-gnu
        profile: minimal
        override: true
    
    - name: Cache cargo registry
      uses: actions/cache@v3
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Cache cargo index
      uses: actions/cache@v3
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Cache cargo build
      uses: actions/cache@v3
      with:
        path: target
        key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Build
      working-directory: rust/hello_world
      run: cargo build --release
    
    - name: Run tests
      working-directory: rust/hello_world
      run: cargo test
    
    - name: Package
      working-directory: rust/hello_world
      shell: powershell
      run: |
        New-Item -ItemType Directory -Force -Path dist | Out-Null
        Copy-Item target/release/hello-world.exe -Destination dist/
        Compress-Archive -Path dist/* -DestinationPath hello-world-windows-x86_64.zip -Force
    
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v3
      with:
        name: hello-world-windows-x86_64
        path: rust/hello_world/*.zip
        if-no-files-found: error

  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install GTK3 dependencies
      run: |
        brew install gtk+3
    
    - name: Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        profile: minimal
        override: true
    
    - name: Cache cargo registry
      uses: actions/cache@v3
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Cache cargo index
      uses: actions/cache@v3
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Cache cargo build
      uses: actions/cache@v3
      with:
        path: target
        key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Build
      working-directory: rust/hello_world
      run: make release
    
    - name: Run tests
      working-directory: rust/hello_world
      run: make test
    
    - name: Package
      working-directory: rust/hello_world
      run: |
        mkdir -p dist
        cp target/release/hello-world dist/
        tar -czf hello-world-macos-x86_64.tar.gz -C dist .
    
    - name: Upload macOS artifact
      uses: actions/upload-artifact@v3
      with:
        name: hello-world-macos-x86_64
        path: rust/hello_world/*.tar.gz
        if-no-files-found: error